 ># 第一章 传感器的概述

人们为了从外界获取信息，必须借助于人类特有的感官系统。而单靠人们自身的感觉器官，在研究自然现象和规律以及生产活动中它们的功能就远远不够了。为了适应这种情况，就需要传感器。因此可以说，传感器是人类五官的重新定义。在四轴飞行器上同样也是如此。飞行器在飞行的过程中为了获取自身的姿态，同样也离不开传感器。
>## 1.1 四轴飞行器中传感器的作用

传感器是一种常用的检测装置，被广泛的应用于多个行业当中。传感器在四轴飞行器上的应用也是非常广泛的，传感器作为飞行控制系统的重要组成部分，在飞行控制系统中具有重要的作用。

要实现对飞机的飞行控制，首先要解决的是如何精确测量飞机的各种飞行参数，如飞机的姿态角、迎角、角速率、过载、飞行高度和速度等，因此出现了各种敏感元件，如陀螺仪、迎角传感器、加速度传感器、高度传感器以及位移和力传感器。在获取精确地姿态数据之后，通过飞控对数据进行实时解析，判断飞行器是否稳定飞行，如果飞行不稳定，人类可迅速做出反应，同时飞控也可通过内置算法调节动力系统，进而保证飞行器稳定的运行。

>## 1.2 四轴飞行器的工作原理

四轴飞行器由机架、飞控（MCU）、传感器和电机与电调组成。我们把飞行器比作一个人，MCU相当于人的大脑，传感器就好比人的五官。人们通过五官来感知世界，大脑作出判断，从而产生动作。而飞行器就只能通过传感器来感知周围的环境，MCU进行判断并产生动作信号。原理如图所示：

<div align=center>

![原理图](pic/.png)

</div>




># 第二章 传感器的基础知识
>## 2.1 传感器的定义

国家标准GB7665-87对传感器下的定义是：“能感受规定的被测量并按照一定的规律转换成可用信号的器件或装置，通常由敏感元件和转换元件组成”。传感器是一种检测装置，它是实现自动检测和自动控制的首要环节。传感器能感受到被测量的信息，并能将检测感受到的信息，按一定规律变换成为电信号或其他所需形式的信息输出，以满足信息的传输、处理、存储、显示、记录和控制等要求。
>## 2.2 传感器的分类
>### 2.2.1 模拟信号型传感器

模拟信号是指用连续变化的物理量所表达的信息，如温度、湿度、压力、长度、电流、电压等等，我们通常又把模拟信号称为连续信号，它在一定的时间范围内可以有无限多个不同的取值。其输出信号为模拟信号的传感器为模拟信号型传感器。

>### 2.2.2 数字信号型传感器

数字信号指自变量是离散的、因变量也是离散的信号，这种信号的自变量用整数表示，因变量用有限数字中的一个数字来表示。在计算机中，数字信号的大小常用有限位的二进制数表示，例如，字长为2位的二进制数可表示4种大小的数字信号，它们是00、01、10和11；若信号的变化范围在-1~1，则这4个二进制数可表示4段数字范围，即[-1, -0.5)、[-0.5, 0)、[0, 0.5)和[0.5, 1]。

由于数字信号是用两种物理状态来表示0和1的，故其抵抗材料本身干扰和环境干扰的能力都比模拟信号强很多；在现代技术的信号处理中，数字信号发挥的作用越来越大，几乎复杂的信号处理都离不开数字信号；或者说，只要能把解决问题的方法用数学公式表示，就能用计算机来处理代表物理量的数字信号。其输出信号为数字信号的传感器为数字信号型传感器。

>### 2.2.3 开关信号型传感器

为通断信号，无源信号，电阻测试法为电阻0或无穷大；  也可以是有源信号，专业叫法是阶跃信号，就是0或1，可以理解成脉冲量。大多呈现两种状态，即0或1。即其输出信号为开关信号的传感器为开关信号型传感器。

>## 2.3 传感器的特性
>### 2.3.1 传感器的动态特性

所谓动态特性，是指传感器在输入变化时，它的输出的特性。在实际工作中，传感器的动态特性常用它对某些标准输入信号的响应来表示。这是因为传感器对标准输入信号的响应容易用实验方法求得，并且它对标准输入信号的响应与它对任意输入信号的响应之间存在一定的关系，往往知道了前者就能推定后者。最常用的标准输入信号有阶跃信号和正弦信号两种，所以传感器的动态特性也常用阶跃响应和频率响应来表示。

>### 2.3.2 传感器的线性度

通常情况下，传感器的实际静态特性输出是条曲线而非直线。在实际工作中，为使仪表具有均匀刻度的读数，常用一条拟合直线近似地代表实际的特性曲线、线性度(非线性误差)就是这个近似程度的一个性能指标。拟合直线的选取有多种方法。如将零输入和满量程输出点相连的理论直线作为拟合直线;或将与特性曲线上各点偏差的平方和为最小的理论直线作为拟合直线，此拟合直线称为最小二乘法拟合直线。

>### 2.3.3 传感器的迟滞性

传感器在输入量由小到大(正行程)及输入量由大到小(反行程)变化期间其输入输出特性曲线不重合的现象成为迟滞。对于同一大小的输入信号，传感器的正反行程输出信号大小不相等，这个差值称为迟滞差值。

>### 2.3.4 传感器的灵敏度

灵敏度是指传感器在稳态工作情况下输出量变化△y对输入量变化△x的比值。它是输出一输入特性曲线的斜率。如果传感器的输出和输入之间显线性关系，则灵敏度S是一个常数。否则，它将随输入量的变化而变化。灵敏度的量纲是输出、输入量的量纲之比。例如，某位移传感器，在位移变化1mm时，输出电压变化为200mV，则其灵敏度应表示为200mV/mm。当传感器的输出、输入量的量纲相同时，灵敏度可理解为放大倍数。提高灵敏度，可得到较高的测量精度。但灵敏度愈高，测量范围愈窄，稳定性也往往愈差。

>### 2.3.5 传感器的分辨力

分辨力是指传感器可能感受到的被测量的最小变化的能力。也就是说，如果输入量从某一非零值缓慢地变化。当输入变化值未超过某一数值时，传感器的输出不会发生变化，即传感器对此输入量的变化是分辨不出来的。只有当输入量的变化超过分辨力时，其输出才会发生变化。

通常传感器在满量程范围内各点的分辨力并不相同，因此常用满量程中能使输出量产生阶跃变化的输入量中的最大变化值作为衡量分辨力的指标。上述指标若用满量程的百分比表示，则称为分辨率。

>### 2.3.6 传感器的重复性

重复性是指传感器在输入量按同一方向作全量程连续多次变化时，所得特性曲线不一致的程度。各条特性曲线越靠近，说明重复性越好，随机误差就越小。

>### 2.3.2 传感器的稳定性

稳定性表示传感器在一个较长的时间内保持其性能参数的能力。理想的情况是不论什么时候，传感器的特性参数都不随时间变化。但实际上，随着时间的推移，大多数传感器的特性会发生改变。这是因为敏感器件或构成传感器的部件，其特性会随时间发生变化，从而影响传感器的稳定性。

># 第三章 传感器的应用
>## 3.1 陀螺仪 MPU-6050
>### 3.1.1 MPU-6050简介
MPU-6050数字传感器是InvenSense公司推出的全球首例6轴运动传感器。它集成了3轴MEMS陀螺仪，3轴MEMS加速计，以及一个可扩展的数字运动处器DMP(Digital Motion Processor),可用第二 个IIC接口连接外部磁力传感器，通过主IIC接口，输出一个9轴信号。
> **特点**
> * 陀螺仪和加速计分别采用16位ADC
> * 自带数字运动处理（DMP），可输出6轴或9轴（需外接磁力计）信号
> * 测量范围可控，3轴角速度传感器（陀螺仪）可测范围±250、±500、±1000、±2000°/秒（dps），3轴加速度传感器可测范围±2、±4、±8、±6g。
> * 自带数字温度传感器
> * 可输出中断，支持姿势识别、摇摄、画面放大缩小、滚动、快速下降中断、high-G中断、零动作感应、触击感应、摇动感应功能
> * 自带1024字节FIFO，有助于降低系统功耗
> * 高达400kHz的IIC通信接口
> * 宽电压，VDD范围2.5V±5%、3.0±5%或3.3±5%，MPU-6050有VLOGIC引脚，用来为IIC输出提供逻辑电平。VLOGIC电压可取1.8±5%或VDD
> * 封装尺寸小：4×4×0.9mm

<div align=center>

QFN封装引脚图

![](PIC/2.png)

引脚说明

![](PIC/4.png)

</div>

>### 3.1.2 工作原理
MPU-6050作为一款物理传感器，其工作原理是利用物理效应，诸如压电效应，磁致伸缩现象，离化、极化、热电、光电、磁电等效应，将被测信号量的微小变化转换成电信号。

下面是MPU-6050的基本框图，由框图可知，传感器通过感知自身的姿态并将姿态信号转换成电压信号，通过16位高精度ADC转化成数字信号并通过自身需求配置寄存器，可使用MPU-6050自带的数字运动处理器，即DMP，将原始数据进行姿态融合解算，可通过IIC直接输出四元数数据，得到四元数之后就可以很方便的计算出欧拉角，从而得到yaw、roll和pitch。

使用内置的DMP，可以大大简化代码的设计，MCU不用进行姿态解算过程，大大降低了MCU负担，从而有更多的时间去处理其他事情，提高系统的实时性。

MPU6050 DMP输出的是姿态解算后的四元数，采用q30格式，也就是放大了2的30次方，我们要得到欧拉角，就得做一个转换，代码如下：

```
      q0=quat[0] / q30;	//q30格式转换为浮点数
      q1=quat[1] / q30;
      q2=quat[2] / q30;
      q3=quat[3] / q30;
      //计算得到俯仰角/横滚角/航向角
      pitch=asin(-2 * q1 * q3 + 2 * q0* q2)* 57.3; //俯仰角
      roll=atan2(2 * q2 * q3 + 2 * q0 * q1, -2 * q1 * q1 - 2 * q2* q2 + 1)* 57.3;//横滚角
      yaw=atan2(2*(q1*q2 + q0*q3),q0*q0+q1*q1-q2*q2-q3*q3) * 57.3;	   //航向角
```
quat[0]~quat[3]：是MPU6050的DMP解算后的四元数，q30格式。
q30：是一个常量：1073741824，即2的30次方。
57.3：是弧度转换为角度，即180/π，这样结果就是以度（°）为单位的。


<div align=center>

MPU-6050基本框图

![ ](PIC/3.png)

</div>
下面我们简单介绍一下软件姿态解算原理：

 * 加速度计

 目前市面上的加速度计从输出上区分为两种：一种是数字的，另一种是模拟的。MPU-6050三轴加速度计是IIC接口的数字传感器，可通过特定的配置设置加速度的量程，并将内部ADC的转换结果读出来，但读出来的数据是以LSB为单位的，它仍然不是g（9.8米/秒^2），需要最后的转换，我们要知道加速度计灵敏度，通常表示为LSB/g。假如我们使用2g量程时，对应灵敏度=16384LSB/G。为了得到最终力值，我们用下面公式：
<div align=center>

**Rx=ADCRx/灵敏度**

</div>
 也就是说，当X轴的计数为ADCRx时，那么对应的加速度值就是（ADCRx/16384）g。
下面回到现实中的加速度计，加速度计受到的力是一个矢量力，那么它又是如何将这些信息告诉我们的呢？下面我们以下面的模型为例，其实加速度计受到的力比作向量R，Rx、Ry、Rz就是实际上真正的现实加速度计的X轴、Y轴、Z轴。我们假设R与X、Y、Z轴之间的角度为Axr、Ayr、Azr。
 <div align=center>

![ ](PIC/加速度计.png)

</div>
可以看到由R和Rx组成的直角三角形：
<div align=center>

**cos(Axr)=Rx/R**

**cos(Ayr)=Ry/R**

**cos(Azr)=Rz/R**
</div>
可以得到 ：

**R=SQRT（Rx^2+Ry^2+Rz^2**

我们发现当使用arccos（）反余弦时有：
<div align=center>

**Axr=arccos(Rx/R)**

**Ayr=arccos(Ry/R)**

**Azr=arccos(Rz/R)**
</div>
已通过很多公式解释加速度计模型。我们也会很快解释陀螺仪以及如何用加速度计和陀螺仪的数据进行整合，以得到更精确的角度估计。在这之前我们先来看看更有用的公式：
<div align=center>

**cosx=cos(Axr)=Rx/R**

**cosy=cos(Ayr)=Ry/R**

**cosz=cos(Azr)=Rz/R**
</div>
这三个公式通常被称为方向余弦。你可以轻松地验证：
<div align=center>

**SQRT（cosx^2+cosy^2+cosz^2）=1**

</div>
这个属性可以避免见识R矢量模（长度）。我们从理论回到现实的传感器输出中，当水平放置MPU-6050，只有Z轴感受到重力向量，它将输出1g。对应的ADC值就是16384（2g的量程）。此时，R就是重力向量，Rx=0，Ry=0，Rz=R=1g。满足R^2=Rx^2+Ry^2+Rz^2 得到重力向量与各轴的夹角
<div align=center>

Axr=arccos(Rx/R)=90度

Ayr=arccos(Ry/R)=90度

Azr=arccos(Rz/R)=0度

</div>

```
加速度计的标定：
当MPU-6050水平放置时，理论上Z轴感受到的重力为16384，X轴、Y轴的度数为0。可实际并非如此，这是由于每个芯片在制作时都不一样，数据手册上的都是理论值，真正芯片在水平放置时可能并不是16384。这时，我们需要找到当每个轴在零重力时的读数，1g重力时的读数，-1g时的读数，计算出一个补偿值，在每次读取ADC结果后都进行补偿。这个过程称为标定。数学公式表示为：
ADCx = K*Gx + Offset
ADCx : 传感器输出
  Gx : 真实加速值
Offset：加速度为0g时传感器输出
   K ：标度因子
```

* 陀螺仪

MPU-6050是测试角速度的传感器，它集成了三轴的陀螺仪。加速度感测范围为±250、±500、±1000与±2000°/sec(dps)。当选择量程为±250dps时，分辨率为131LSB/（°/s）。即当载体在X+轴转动1dps时，ADC将输出131。
<div align=center>

![ ](PIC/5.png)

</div>
MPU-6050的每个陀螺仪各自负责检测相应轴的转动速度，也就是检测围绕各个轴转动的速度。像三轴的陀螺仪将同时检测X、Y、Z轴的旋转。回到加速度向量模型，将相关角度符号补上，如图所示：
<div align=center>

![ ](PIC/陀螺仪.png)

</div>
由模型我们首先定义：

Rxz-是R向量在XZ平面上的投影

Ryz-是R向量在YZ平面上的投影

Axz-是Rxz和Z轴间的夹角

Ayz-是Ryz和Z轴间的夹角

我们已经知道陀螺仪是测量角度变化率的传感器。为了解释这一点，我们假设，我们已经测量围绕Y轴的旋转角（Axz）在t0时刻，定义为Axz0，接下来我们在下一时间点t1测量角度为Axz1。变化率将被计算如下:
<div align=center>

RateAxz=(Axz1-Axz0)/（t1-t0）

</div>
如果Axz单位为度，并以秒为单位，那么RateAxz将以deg/s表示。MPU-6050并不会以deg/s单位输出，我们需要在读完后进行转换。我们先来看看各个量程的灵敏度。
<div align=center>

![](PIC/角速度量程.png)

</div>
通过IIC接口读出的转换结果ADC值并不是以秒为单位。一般按以下公式进行转换：
<div align=center>

**Anglerate = ADCrate/灵敏度**

</div>
以量程±1000°/s为例，假设读取X轴的ADC值为200，从表中得知在±1000°/s下的灵敏度为32.8LSB/(°/s)。根据公式：
<div align=center>

Anglerate =200/32.8=6.09756°/s

</div>
这就是说。MPU-6050检测到设备正在以约6度每秒的速度绕X轴旋转。ADC值并不都是正的，请注意，当出现负数时，意味着该设备从现有的正方向相反的方向旋转。


>### 3.1.3 基本应用电路

<div align=center>

典型应用电路原理图

![](PIC/1.png)

</div>

>### 3.1.4 基本配置方法

>#### ① 初始化IIC接口

MPU-6050作为从设备连接到系统芯片时，SDA和SCL信号线通常需要接上拉电阻到VDD。最大总线速率为400kHz。MPU-6050的Slave地址为b110100X，7位字长，最低有效位X由AD0管脚上的逻辑电平决定。这样就可以允许两个MPU-6050连接到同一条IIC总线，此时，一个设备的地址为b1101000（AD0为逻辑低电平），另一个为b1101001（AD0为逻辑高电平）。

 **IIC通讯协议：**

* 开始（S）和结束（P）标志。当SCL线为高电平时，SDA线由高到低的下降沿，为传输开始标志（S）。直到主设备发出结束信号（P），否则总线状态一直为忙。结束标志（P）规定为，当SCL线为高电平时，SDA线由低到高的上升沿。
<div align=center>

![](PIC/IIC1.png)
START and STOP Conditions
</div>
* 数据传送/应答。IIC的数据字节定义为8-bits长度，对每次传送的总字节数量没有限制。对每次传输必须伴有一个应答（ACK）信号，其时钟由主设备提供，而真正的应答信号由从设备发出，在时钟为高时，通过拉低并保持SDA的值来实现。如果从设备忙，它可以使SCL保持在低电平，这会强制使主设备进入进入等待状态。当从设备空闲后，并释放时钟线，原来的数据传输才会继续。
<div align=center>

![](PIC/IIC2.png)
Acknowledge on the IIC Bus
</div>
* 通信。开始标志发出后，主设备会传送一个7位的Slave的地址，并且后面跟着一个第8位，称为Read/Write位。R/W位表示主设备是在接收从设备的数据还是在向其发送数据。然后，主设备释放SDA线，等待从设备的应答信号（ACK）。每一个字节的传输都要跟随一个应答位。应答产生时，从设备将SDA线拉低并且在SCL为高电平时保持低。数据传输总是以停止标志（P）结束，然后释放通信线路。然而，主设备也可产生重复的开始信号去操作另一台设备，而不发出结束标志。综上所述，所有的SDA信号变化都要在SCL时钟为低电平时进行，除了开始和结束标志。
<div align=center>

![](PIC/IIC3.png)
Complete IIC Data Transfer
</div>
如果要写MPU-6050寄存器，主设备除了发出开始标志（S）和地址位，还要加R/W位，0为写，1为读。在第九个时钟周期（高电平时），MPU-6050产生应答信号。然后主设备开始传送寄存器地址（RA），接到应答后，开始传送寄存器数据，然后仍然要有应答信号，依次类推。

单字节写入时序:
<div align=center>

![](PIC/单字节写入.png)
</div>
连续写入时序:
<div align=center>

![](PIC/连续写入.png)
</div>
如果要读取MPU-6050寄存器的值，首先由主设备产生开始信号（S），然后发送从设备的地址位和一个写数据位，然后发送寄存器地址，才能开始读寄存器。紧接着，收到应答信号后，主设备再发出一个开始信号，然后发送从设备地址位和一个读数据位。然后，作为从设备的MPU-6050产生应答信号并开始发送寄存器数据。通信以主设备产生的拒绝应答信号（NACK）和结束标志（P）结束。拒绝应答信号（NACK）产生定义为SDA数据在第九个时钟周期一直为高。

单字节读出时序:
<div align=center>

![](PIC/单字节读出.png)
</div>
连续读出时序:
<div align=center>

![](PIC/连续读出.png)
</div>
信号说明:
<div align=center>

![](PIC/信号说明.png)
</div>
参考程序：

```
//初始化函数
void I2C_Init(void)
{
       SCL=1;
       delay();
       SDA=1;
       delay();
}
//启动信号
void I2C_Start(void)
{
       SDA=1;
       delay();
       SCL=1;
       delay();
       SDA=0;
       delay();
}
//停止信号
void I2C_Stop(void)
{
       SDA=0;
       delay();
       SCL=1;
       delay();
       SDA=1;
       delay();
}
//应答信号
void I2C_ACK(void)
{
       uchar i=0;
       SCL=1;
       delay();
       while((SDA==1)&&(i<255))
       i++;
       SCL=0;
       delay();
}
//写一个字节
void I2C_Writebyte(uchar date)
{
       uchar i,temp;
       temp=date;
       for(i=0;i<8;i++)
       {
              temp=temp<<1;
              SCL=0;
              delay();
              SDA=CY;
              delay();
              SCL=1;
              delay();
       }
       SCL=0;
       delay();
       SDA=1;
       delay();
}
//读一个字节
uchar I2C_Readbyte()
{
       uchar i,j,k;
       SCL=0;
       delay();
       SDA=1;
       for(i=0;i<8;i++)
       {
              SCL=1;
              delay();
              if(SDA==1)
                j=1;
              else
                j=0;
              k=(k<<1)|j;
              SCL=0;
              delay();
       }
       delay();
       return k;
}
//指定地址写一个字节数据
Void I2C_Write_add(uchar address,uchar info)
{
       I2C_Start();
       I2C_Writebyte(0xa0);
       I2C_ACK();
       I2C_Writebyte(address);
       I2C_ACK();
       I2C_Writebyte(info);
       I2C_ACK();
       I2C_Stop();
}
//指定地址读一个字节数据
uchar I2C_Read_add(uchar address)
{
       uchar dd;
       I2C_Start();
       I2C_Writebyte(0xa0);
       I2C_ACK();
       I2C_Writebyte(address);
       I2C_ACK();
       I2C_Start();
       I2C_Writebyte(0xa1);
       I2C_ACK();
       dd=I2C_Readbyte();
       I2C_Stop();
       return dd;
}
```
>#### ② 复位MPU-6050

由电源寄存器1（0x6b）控制。

>#### ③ 设置角速度传感器和加速度传感器的满量程范围

由陀螺仪配置寄存器(0X1B)和加速度传感器配置寄存器(0X1C)设置 。
>#### ④ 设置其他参数

配置中断，由中断使能寄存器(0X38)控制；

设置AUX IIC接口，由户控制寄存器(0X6A)控制；

设置FIFO，由FIFO使能寄存器(0X23)控制；

设置陀螺仪采样率 ，由采样率分频寄存器(0X19)控制；

设置数字低通滤波器，由配置寄存器(0X1A)控制。
>#### ⑤ 设置系统时钟

由电源管理寄存器1(0X6B)控制。一般选择x轴陀螺PLL作为时钟源，以获得更高精度的时钟。
>#### ⑥ 使能角速度传感器（陀螺仪）和加速度传感器

由电源管理寄存器2(0X6C)控制。
>#### ⑦ 初始化完成，即可读取陀螺仪、加速度传感器和温度传感器的数据

>### 3.1.5 寄存器介绍
下面重点为大家介绍一下常用的几个寄存器，至于其他不常用的寄存器大家用到时可自行查阅数据手册。

 >####电源管理寄存器1（0X6B）（PWR_MGMT_1）
 <div align=center>

![](PIC/电源管理寄存器1.png)

</div>
此寄存器允许用户配置电源模式和时钟源。

CYCLE位，当失能SLEEP且CYCLE位置1，MPU-6050进入循环模式。在循环模式，设备在睡眠模式和唤醒模式间循环，根据LP_WAKE_CTRAL寄存器设定的速率从加速度计采样样品数据。

DEVICE_RESE=1，复位MPU6050，复位完成后，自动清零。

SLEEP=1，进入睡眠模式；SLEEP=0，正常工作模式。

TEMP_DIS，用于设置是否使能温度传感器，设置为0，则使能温度传感器。

CLKSEL[2:0]，用于选择系统时钟源，如下表所示：
<div align=center>

![](PIC/时钟源.png)

</div>


>####陀螺仪配置寄存器（0X1B）（GYROSCOPE CONFIGURATION）
<div align=center>

![](PIC/陀螺仪配置寄存器.png)

</div>

XG_ST：     该位置位X轴进行自检

YG_ST：     该位置位Y轴进行自检

ZG_ST：     该位置位Z轴进行自检

FS_SEL：    选择陀螺仪的满量程范围

该寄存器我们只关心FS_SEL[1:0]这两个位，用于设置陀螺仪的满量程范围：0，±250°/S；1，±500°/S；2，±1000°/S；3，±2000°/S；我们一般设置为3，即±2000°/S，因为陀螺仪的ADC为16位分辨率，所以得到灵敏度为：65536/4000=16.4LSB/(°/S)。
<div align=center>

![](PIC/陀螺仪量程.png)

</div>

>####加速度传感器配置寄存器（0X1C）（ACCELEROMETER CONFIGURATION）
<div align=center>

![](PIC/加速度计配置寄存器.png)

</div>

XA_ST：     该位置1，加速度计的X轴进行自检

YA_ST：     该位置1，加速度计的Y轴进行自检

ZA_ST：     该位置1，加速度计的Z轴进行自检

AFS_SEL：    选择加速度计的满量程范围

该寄存器我们只关心AFS_SEL[1:0]这两个位，用于设置加速度传感器的满量程范围：0，±2g；1，±4g；2，±8g；3，±16g；我们一般设置为0，即±2g，因为加速度传感器的ADC也是16位，所以得到灵敏度为：65536/4=16384LSB/g。
<div align=center>

![](PIC/加速度计量程.png)

</div>

>####FIFO使能寄存器（0X23）（FIFO ENABLE）
<div align=center>

![](PIC/FIFO使能寄存器.png)

</div>
如果此寄存器中相关的传感器FIFO_EN位被置1，相应传感器的数据寄存器中的数据就会被加载到FIFO缓冲区。

TEMP_FIFO_EN:该位置1，该位使能TEMP_OUT_H和TEMP_OUT_L可以加载到FIFO缓冲区。

XG_FIFO_EN:该位置1，该位使能GYRO_XOUT_H和GYRO_XOUT_L可以加载到FIFO缓冲区。

YG_FIFO_EN:该位置1，该位使能GYRO_YOUT_H和GYRO_YOUT_L可以加载到FIFO缓冲区。

ZG_FIFO_EN:该位置1，该位使能GYRO_ZOUT_H和GYRO_ZOUT_L可以加载到FIFO缓冲区。

ACCEL_FIFO_EN:该位置1，该位能ACCEL_XOUT_H，ACCEL_XOUT_L，ACCEL_YOUT_H，ACCEL_YOUT_L，ACCEL_ZOUT_H和ACCEL_ZOUT_L可以加载到FIFO缓冲区。

SLV2_FIFO_EN:该位置1，该位使能EXT_SENS_DATA寄存器和从机2可以加载到FIFO缓冲区。

SLV1_FIFO_EN:该位置1，该位使能EXT_SENS_DATA寄存器和从机1可以加载到FIFO缓冲区。

SLV0_FIFO_EN:该位置1，该位使能EXT_SENS_DATA寄存器和从机0可以加载到FIFO缓冲区。

注意：加速度传感器的3个轴，全由1个位（ACCEL_FIFO_EN）控制，只要该位置1，则加速度传感器的三个通道都开启FIFO了。

>####陀螺仪采样率分频寄存器（0X19）（SAMPLE  RATE DIVIDER）
<div align=center>

![](PIC/陀螺仪采样率分频寄存器.png)

</div>
该寄存器用于设置MPU6050的陀螺仪采样频率，计算公式为：
<div align=center>

采样频率 = 陀螺仪输出频率 / (1+SMPLRT_DIV)
</div>
这里陀螺仪的输出频率，是1Khz或者8Khz，与数字低通滤波器（DLPF）的设置有关。当DLPF_CFG=0/7的时候，频率为8Khz，其他情况是1Khz。而且DLPF滤波频率一般设置为采样率的一半。采样率，我们假定设置为50Hz，那么：SMPLRT_DIV=1000/50-1=19。

>####配置寄存器（0X1A）（CONFIGURATION）
<div align=center>

![](PIC/配置寄存器.png)

</div>
该寄存器配置外部FSYNC引脚采样，陀螺仪和加速度计的数字低通滤波器。通过配置EXT_SYNC_SET可以使用一个外部信号连接到FSYNC引脚进行采样。

FSYNC引脚的信号的变化被锁存，使短的选通信号可能被捕获。锁存FSYNC信号将作为采样的采样频率。采样结束后，锁存器将复位到当前的FSYNC信号状态。

EXT_CYNC_SET的值确定采样的值将代替传感器数据寄存器中的最低有效位。替换如下表：
<div align=center>

![](PIC/替换最低有效位.png)

</div>
DLPF（数字低通滤波器）由DLPF_CFG配置。加速度计和陀螺仪根据DLPF_CFG的值被过滤。下表为过滤情况：
<div align=center>

![](PIC/低通滤波器.png)

</div>

>####电源管理寄存器2（0X6C）（PWR_MGMT_2）
<div align=center>

![](PIC/电源管理寄存器2.png)

</div>
该寄存器的LP_WAKE_CTRL用于控制低功耗时的唤醒频率。也允许用户让加速度计和陀螺仪的个别轴进入待机模式。

只让MPU-6050的加速度计进入低功耗模式的步骤如下：

* 置CYCLE位为1
* 置SLEEP位为1
* 置TEMP_DIS位为1
* 置STBY_XG，STBY_YG,STBY_ZG位为1

上述所有位可以在电源管理1寄存器中找到。

在这种模式下，设备会关闭除了主IIC接口外其他所有设备，加速度计只在固定的间隔唤醒并测量一次。唤醒的频率可以通过配置LP_WAKE_CTRL实现如下:
<div align=center>

![](PIC/唤醒采样频率.png)

</div>

LP_WAKE_CTRL：配置加速度计在低功耗下的唤醒频率

STBY_XA：该位置1，加速度计的X轴进入待机模式。

STBY_YA：该位置1，加速度计的Y轴进入待机模式。

STBY_ZA：该位置1，加速度计的Z轴进入待机模式。

STBY_XG：该位置1，陀螺仪的X轴进入待机模式。

STBY_YG：该位置1，陀螺仪的Y轴进入待机模式。

STBY_ZG：该位置1，陀螺仪的Z轴进入待机模式。
>####加速度传感器数据输出寄存器（0X3B~0X40）（ACCELEROMETER MEASUREMENTS）
<div align=center>

![](PIC/加速度计测量值.png)

</div>

加速度计测量值寄存器和温度测量值寄存器，陀螺仪测量值寄存器，外部传感器数据寄存器都是由2个寄存器集合组成：一个内部寄存器集合和一个面向用户的读取寄存器集合。

加速度计传感器的内部寄存器集合里的数据根据采样频率更新。以此同时，每当串口接口处于闲置状态，面向用户的读取寄存器集合会复制内部寄存器集合的数据值。这保证了突发读取时传感器寄存器可以读到相同的采样时刻的测量值。请注意，如果没有突发读取，用户通过检测数据就绪中断确保一组单字节的读取在相应的采样时刻。

每个16位加速度计测量值的量程定义在ACCEL_FS寄存器。对于每个满量程的设置，ACCEL_xOUT里加速度计测量值的灵敏度最低分辨率如下表：
<div align=center>

![](PIC/加速度计分辨率.png)

</div>

ACCEL_XOUT：由2部分组成的16位数值存储最近X轴加速度计的测量值。

ACCEL_YOUT：由2部分组成的16位数值存储最近Y轴加速度计的测量值。

ACCEL_ZOUT：由2部分组成的16位数值存储最近Z轴加速度计的测量值。

>####温度传感器数据输出寄存器（0X41~0X42）（TEMPERATURE MEASUREMENTS）
<div align=center>

![](PIC/温度测量值.png)

</div>
温度传感器的内部寄存器集合里的数据根据采样频率更新。以此同时，每当串口接口处于闲置状态，面向用户的读取寄存器集合会复制内部寄存器集合的数据值。这保证了突发读取时传感器寄存器可以读到相同的采样时刻的测量值。请注意，如果没有突发读取，用户通过检测数据就绪中断确保一组单字节的读取在相应的采样时刻。

通过读取0X41（高8位）和0X42（低8位）寄存器得到，温度换算公式为：
<div align=center>

**Temperature in degrees C = 36.53 + (TEMP_OUT Register Value as a signed quantity)/340**
</div>

TEMP_OUT: 16位有符号数值。存储最近的温度传感器测量值。
>####陀螺仪数据输出寄存器（0X43~0X48）（GYROSCOPE MEASUREMENTS）
<div align=center>

![](PIC/陀螺仪测量值.png)

</div>

陀螺仪传感器的内部寄存器集合里的数据根据采样频率更新。以此同时，每当串口接口处于闲置状态，面向用户的读取寄存器集合会复制内部寄存器集合的数据值。这保证了突发读取时传感器寄存器可以读到相同的采样时刻的测量值。请注意，如果没有突发读取，用户通过检测数据就绪中断确保一组单字节的读取在相应的采样时刻。

每个16位陀螺仪测量值的量程定义在FS_SEL寄存器。对于每个满量程的设置，GYRO_xOUT里陀螺仪测量值的灵敏度最低分辨率如下表：
<div align=center>

![](PIC/陀螺仪分辨率.png)

</div>

GYRO_XOUT：由2部分组成的16位数值。存储最近X轴陀螺仪的测量值。

GYRO_YOUT：由2部分组成的16位数值。存储最近Y轴陀螺仪的测量值。

GYRO_ZOUT：由2部分组成的16位数值。存储最近Z轴陀螺仪的测量值。

>## 3.2 磁力计 HMC5883L
>### 3.2.1 HMC5883L简介
霍尼韦尔 HMC5883L 是一种表面贴装的高集成模块，并带有数字接口的弱磁传感器芯片，应用于低成本罗盘和磁场检测领域。HMC5883L 包括最先进的高分辨率HMC118X系列磁阻传感器，并附带霍尼韦尔专利的集成电路包括放大器、自动消磁驱动器、偏差校准、能使罗盘精度控制在1°~2°的12位模数转换器.简易的I2 C 系列总线接口。HMC5883L 是采用无铅表面封装技术，带有16引脚，尺寸为3.0X3.0X0.9mm。HMC5883L 的所应用领域有手机、笔记本电脑、消费类电子、汽车导航系统和个人导航系统。

 HMC5883L 采用霍尼韦尔各向异性磁阻(AMR)技术，该技术的优点是其他磁传感器技术所无法企及。这些各向异性传感器具有在轴向高灵敏度和线性高精度的特点.传感器带有的对于正交轴低敏感行的固相结构能用于测量地球磁场的方向和大小，其测量范围从毫高斯到 8 高斯(gauss)。 霍尼韦尔的磁传感器在低磁场传感器行业中是灵敏度最高和可靠性最好的传感器。

>**特点**
> * 12-bit ADC与低干扰AMR传感器，能在 ±8高斯的磁场中实现5毫高斯分辨率
> * 内置自检功能
> * 低电压工作(2.16-3.6V)和超低功耗 （100uA）
> * 内置驱动电路
> * I2C数字接口
> * 最大输出频率可达160Hz
> * 有相应软件及算法支持
> * 磁场范围广（+/-8Oe）
> * 无引线封装结构
> * 三轴磁阻传感器和ASIC都被封装在 3.0×3.0×0.9mm LCC表面装配中


>### 3.2.2 工作原理

在介绍磁力计原理之前我们先了解一下惠斯通电桥。

<div align=center>

![](PIC/惠斯通电桥.png)

</div>

如上图所示。R1/R2/R3/R4是初始状态相同的AMR电阻，但是R1/R2和R3/R4具有相反的磁化特性。当检测到外界正交偏置磁场时，R1/R2阻值增加 △R而R3/R4减少 △R。这样在没有外界正交偏置磁场的情况下，电桥的输出为零；而在有外界磁场时电桥的输出为一个微小的电压 △V。磁力计就是利用惠更斯电桥检测AMR阻值的变化，来感觉外部的磁力。当然这里的 △V很小，需要进入放大电路处理。

在此解释一下电桥的关键部件AMR电阻，也叫各向异性磁电阻效应，简称磁控电阻。当外部的磁力线垂直于电阻时与外部磁力线平行于电阻时呈现不一样的电阻率。

HMC5883是三轴磁力计，当然它内部有三个电桥。将三维磁阻传感器按照载体三维坐标系安装，通过测量载体空间磁场的三维磁感应强度，按照一定的算法就可以计算出载体在空间的姿态信息。这就是电子指南针。

* 磁干扰
这个世界上不是只有地球才能产生磁场，我们身边很多的物体都是可以产生磁场的，比如磁铁，电机，钢筋结构的房子，通电流的直导线也会产生磁场。

电子指南针主要通过感知地球磁场的存在来计算磁北极的方向。然而由于地球磁场在一般情况下只有微弱的0.5高斯左右，而一个普通的手机喇叭当距离2厘米时仍会产生大约4高斯的磁场，一个手机马达在相距2厘米时会有大约6高斯的磁场，这一特点使得针对电子设备表面的地球磁场的测量很容易受到电子设备本身的干扰。

磁场干扰是指由于具有磁性物质或者可以影响局部磁场强度的物质存在，使得磁传感器所在位置上的地球磁场发生了偏差。

磁干扰又分为两种，一种是硬磁干扰，另一种是软磁干扰。

硬铁磁场由磁力计平台上的永久性磁铁和被磁化的钢铁物质组成，其特点是当载体位于某一固定位置时，其强度为一定值，不随航向的变化而变化。软铁磁场可认为由地球磁场与磁力计周围的磁化物质相互作用而产生。与硬铁磁场不同的是，软铁磁场强度的大小与磁力计的方位有关。

* 磁校准

受电子环境和罗盘自身因素的影响，电子磁罗盘常存在较大的航向角误差，因此经常需要在使用前校准。磁罗盘校准的一般方法是使安装有磁罗盘的载体做特定的动作，或者将载体转动到某些特定的角度，得到磁罗盘在不同姿态下的磁场强度测量值。通过对测量值分析，进行磁罗盘的校准。


>### 3.2.3 基本应用电路

<div align=center>

![](PIC/HMC5883应用电路.png)

</div>

>### 3.2.4 基本配置方法
>#### ① 初始化IIC接口
HMC5883L通过两线IIC总线系统作为一个从机装置进行通信。HMC5883L使用是一个IIC协议所定义的简化后的通信接口协议。数据传输速率是标准模式100kbps或400kbps速率，如I2C总线规格中所规定。总线位格式是一个8位数据/地址传送和1位应答位。格式的数据字节（有效载荷）应区分HMC5883L从机上的大小写的ASCII字符或二进制数据，以及返回的二进制数据。负二进制值将是以二进制的补码形式。默认（出厂） HMC5883LL  7位从机地址为0x3C的写入操作，或0x3D的读出操作。

由于上一节中已经介绍了IIC通讯协议，这里就不再加以介绍。
>#### ② 配置HMC5883L工作模式
由模式寄存器（0X02）控制。

>#### ③ 设置数据输出速率和测量配置
由配置寄存器 A （0X00）控制。
>#### ④ 设置装置的增益
由配置寄存器 B （0X01)控制。

>#### ⑤ 初始化FIFO数组
读取并更新数据，等待使用。
>#### ⑥ 初始化完成，即可读取磁力计HMC5883L数据。





>### 3.2.5 寄存器介绍
>#### 配置寄存器A（0X00）（Configuration Register A）
配置寄存器是用来配置该装置设置的数据输出速率和测量配置。 CRA0通过CRA7表明位的位置，用CAR指示在配置寄存器中的位。 CRA7指示数据流的第一位。括号中的数目显示是该位的默认值。
|CRA7|CRA6|CRA5|CRA4|CRA3|CRA2|CRA1|CRA0|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| (1)  |  MA1(1) |MA0(1)|DO2(1)   |DO1(0)   |DO0(0)   |MS1(0)   |MS0(0)   |
<div align=center>

配置寄存器A位分配

|位置|名称|描述|
|:-:|:-:|:-:|
|  CRA7 | CRA7 | 这个位必须清除以正确运行  |
| CRA6至CRA5  | MA1至MA0  | 在每次测量输出中选择采样平均数（1-8） 00=1；01=2；10=4；11=8（缺省） |
| CRA4至CRA2  | DO2至DO0  | 数据输出速率位。这些位设置数据写入所有三个数据输出寄存器的速度  |
| CRA1 至 CRA0  | MS1 至 MS0  | 测量配置位。这些位定义装置的测量流程，特别是是否纳入适用的偏置到测量中去。  |

</div>
下表的数据显示在连续测量模式下的所有可选的输出速率。所有这三个通道应在某一特定数据速率下测量。其他输出速率可以通过控制单测量模式下的DRDY中断引脚来获得，最大速率为160Hz。

|DO2|DO1|DO0|标准数据输出速率（Hz）|
|:-:|:-:|:-:|:-:|
| 0  | 0  | 0  | 0.75  |
| 0  | 0  | 1  | 1.5  |
| 0  |  1 | 0  | 3  |
| 0  |  1 | 1  | 7.5  |
| 1  |  0 | 0  | 15（默认）|
| 1  |  0 | 1  | 30  |
| 1  |  1 | 0  | 75  |
| 1  |  1 | 1  | 不使用  |
<div align=center>
测量模式
</div>

|MS1|MS0|模式|
|:-:|:-:|:-:|
| 0  | 0  | 正常测量配置（默认）。在正常的测量配置下，装置按照正常测量流程，负载电阻的 正极引脚和负极引脚保持浮动和高阻抗。  |
| 0  | 1  | X、Y、Z轴正偏压配置。在该配置中，正电流强制通过负载电阻到达X、Y、Z三轴。  |
| 1  | 0  | X、Y、Z轴负偏压配置，在该配置中，负电流强制通过负载电阻到达X、Y、Z三轴。  |
| 1  | 1  | 此配置预留。  |


>#### 配置寄存器B（0X01）（Configuration Register B）
配置寄存器B设置装置的增益。 CRB0通过CRB7识别位的位置，用CRB指示在配置寄存器里的位。CRB7表示数据流中的第一位。括号中的数目显示的是位的默认值。
|CRB7|CRB6|CRB5|CRB4|CRB3|CRB2|CRB1|CRB0|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| GN2 (0)  |  GN1 (0) | GN0 (1) | (0)  | (0)   | (0)   | (0)   | (0) |
<div align=center>
配置寄存器 B 数据位设置说明
</div>

|位置|名称|描述|
|:-:|:-:|:-:|
|  CRB7 至 CRB5  | GN2 至GN0 | 增益配置位。这些位为装置设定增益。对所有通道增益配置是共同的。  |
| CRB4至 CRB0  | 0  | 这一位必须清除以正确运行。 |

下表描述增益设置。使用以下“增益”一栏将counts转换成Guass。在总共磁场强度引起所有数据输出存储器中一个溢位（饱和）时选择较低的增益值（高GN#值）。

|GN2|GN1|GN0|推荐的传感器磁场范围|增益 (Counts/高斯)|输出范围|
|:-:|:-:|:-:|:-:|:-:|:-:|
| 0  | 0  | 0  | ±0.88Ga  | 1370  | 0xF800–0x07FF (-2048–2047 )  |
| 0  | 0  | 1  | ±1.3Ga  | 1090(缺省)  | 0xF800–0x07FF (-2048–2047 )  |
| 0  | 1  | 0 | ±1.9Ga  | 820  | 0xF800–0x07FF (-2048–2047 )  |
| 0  | 1  |  1 | ±2.5Ga  | 660  | 0xF800–0x07FF (-2048–2047 )  |
| 1  | 0  | 0  | ±4.0Ga  | 440  | 0xF800–0x07FF (-2048–2047 )  |
| 1  | 0  | 1  | ±4.7Ga  | 390  | 0xF800–0x07FF (-2048–2047 )  |
| 1  | 1  | 0  | ±5.6Ga  | 330  | 0xF800–0x07FF (-2048–2047 )  |
| 1  | 1  | 1  | ±8.1Ga   | 230  | 0xF800–0x07FF (-2048–2047 )  |

 

>#### 模式寄存器（0X02）（Mode Register）
|MR7|MR6|MR5|MR4|MR3|MR2|MR1|MR0|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| (1)  | (0) | (0) | (0)  | (0)   | (0)   | MD1(0)   | MD0(1) |
<div align=center>
模式寄存器位分配
</div>

|位置|名称|描述|
|:-:|:-:|:-:|
|  MR7 至MR2  | 0 | 这些位必须清除以正确运行。每一次单测量操作后MR7位在内部设置好。  |
| MR1 至MR0  | MD1至MD0 | 模式选择位。用于设定装置的操作模式。 |

|MD1|MD0|模式|
|:-:|:-:|:-:|
| 0 | 0 | 连续测量模式。在连续测量模式下，装置不断进行测量，并将数据更新至数据寄存器。RDY升高，此时新数据放置在所有三个寄存器。在上电或写入模式或配置寄存器后，第一次测量可以在三个数据输出寄存器经过一个2/fDO后设置，随后的测量可用一个频率fDO进行 ， fDO为数据输出的频率。 |
| 0 | 1 | 单一测量模式（默认）。当选择单测量模式时，装置进行单一测量，RDY设为高位并回到闲置模式。模式寄存器返回闲置模式位值。测量的数据留在输出寄存器中并且RDY仍然在高位，直到数据输出寄存器读取或完成另一次测量。 |
| 1 | 0 | 闲置模式。装置被放置在闲置模式。 |
| 1 | 1 | 闲置模式。装置被放置在闲置模式。 |



>#### 数据输出 X 寄存器 A 和 B

<div align=center>

![](PIC/X寄存器AB.png)

</div>

数据输出X寄存器是两个8位寄存器，数据输出寄存器A和B。这些寄存器储存从通道X所测量结果。数据输出X寄存器A储存一个来自测量结果中的MSB(高位数据)，数据输出X寄存器B储存一个来自测量结果中的LSB（低位数据）。存储在这两个寄存器的值是一个16位值以二进制的补码形式存在，其范围是0xF800到0x07FF。DXRA0至DXRA7、DXRB0至DXRB7标识出位置， DXRA和DXRB标识出在数据输出寄存器X中的位。DXRA7和DXRB7标识出数据流的第一位，括号中的数目显示该位的默认值。

在事件的ADC上溢或下溢阅读给定的通道，或者如果有一个数学溢出的过程，这种数据寄存器将包含-4096的值。在下一次有效测量完成进行之后，该寄存器上的值将被清除。

>#### 数据输出 Y 寄存器 A 和 B
<div align=center>

![](PIC/Y寄存器AB.png)

</div>

数据输出Y寄存器是两个8位寄存器，数据输出寄存器A和B，这些寄存器储存从通道Y所测量的结果。数据输出Y寄存器A储存一个来自测量结果中的MSB(高位数据)，数据输出Y寄存器B包含一个来自测量结果中的LSB（低位数据）。存储在这两个寄存器的值是一个16位值以二进制的补码形式存在，其范围是0xF800到0x07FF。DYRA0至DYRA7、DYRB0至DYRB7标识位置， DYRA和DYRB标识在数据输出寄存器Y中的位。DYRA7和DYRB7标识数据流的第一位。括号中的数目显示该位的默认值。

 在事件的ADC上溢或下溢阅读给定的通道，或者如果有一个数学溢出的过程，这种数据寄存器将包含值为-4096。在下一次有效测量进行之后，该寄存器上的值将被清除。

>#### 数据输出 Z 寄存器 A 和 B
<div align=center>

![](PIC/Z寄存器AB.png)

</div>

数据输出Z寄存器是两个8位寄存器，数据输出寄存器A和B，这些寄存器储存从通道Z所测量的结果。数据输出Z寄存器A储存一个来自测量结果中的MSB(高位数据)，数据输出Z寄存器B包含一个来自测量结果中的LSB（低位数据）。存储在这两个寄存器的值是一个16位值以二进制的补码形式存在，其范围是0xF800到0x07FF。DZRA0至DZRA7、DZRB0至DZRB7标识位置，DZRA和DZRB，标识在数据输出寄存器Z中的位。DZRA7和DZRB7标识数据流的第一位。括号中的数目显示该位的默认值。

在事件的ADC上溢或下溢阅读给定的通道，或者如果有一个数学溢出的过程，这种数据寄存器将包含价值-4096。在下一次有效测量进行之后，该寄存器上的值将被清除。

```
 注意：
 当一个或一个以上的输出寄存器在被读取时，如果所有六种数据输出寄存器未被读取完，那么新的数据不能被更新到相应的数据输出寄存器。这一要求也影响DRDY和RDY ，在新的数据未被更新到所有输出寄存器之前是不能被清除的。
```

>#### 状态寄存器（0X09）（Status Register）
<div align=center>

![](PIC/HMC5883状态寄存器.png)

</div>

|位置|名称|描述|
|:-:|:-:|:-:|
|  SR7 至SR2  | 0 | 这些位预留  |
| SR1  | LOCK | 数据输出寄存器锁存。当六个数据输出寄存器上的一些但不是全部数据被读取时，该位置位。当此位置位时，六个数据输出寄存器被锁定且任何新的数据将不会被更新至这些寄存器中，除非符合以下三个条件之一： 一，所有6个寄存器已被读取或模式改变，二，模式发生变化，三，测量配置发生变化。 |
| SR0  | RDY  | 准备就绪位。当数据都写入了6个数据寄存器，该位置位。在一个或几个数据写入输出寄存器以后且在装置开始向数据输出寄存器写入数据时该位被清除。当RDY位已清除， RDY应保持清除状态至少250微秒。 DRDY引脚可被用来作为一种替代的状态寄存器的监测装置为测量数据。  |
>#### 识别寄存器A (0x0A)（Identification Register A）
<div align=center>

![](PIC/HMC5883识别寄存器A.png)

</div>

识别寄存器A是用来识别装置。IRA0通过IRA7表明位的位置，而IRA表明在识别寄存器A中的位。IRA7指数据流的第一位。括号中的数目显示的默认值是位   该装置的识别值存储在本寄存器中。这是一个只读寄存器。

寄存器值。 ASCII值H

>#### 识别寄存器B (0x0B)（Identification Register B）
<div align=center>

![](PIC/HMC5883识别寄存器B.png)

</div>

识别寄存器B是用来识别装置。IRB0到IRB7表明位的位置，而IRB表明在识别寄存器B中的位。IRB7指数据流的第一位。

寄存器值。 ASCII值4
>#### 识别寄存器C (0x0C)（Identification Register C）
<div align=center>

![](PIC/HMC5883识别寄存器C.png)

</div>

鉴定寄存器C是用来识别装置，IRC0到IRC7表明位的位置，而IRC表明在识别寄存器C中的位，IRC7指数据流的第一位。

寄存器值。 ASCII值3
>### 3.2.6 使用说明
* 操作实例

HMC5883L有一个从没有电压相当稳定快速时间和数据检索做好准备。标称6毫秒在出厂默认的单一测量模式下是指在6个字节的磁场数据寄存器（DXRA，DXRB，DYRA，DYRB，DZRA和DZRB）中填充一个有效的第一个测量。   要改变测量模式到连续测量模式，在通电时间后传送三个字节：0x3C 0x02 0x00   将00写入第二寄存器或模式寄存器以完成从单一模式切换到连续测量模式的设置。随着数据速率在出厂默认的15Hz更新，在查询HMC5883L数据寄存器进行新的测量之前，I2C主机允许产生一个67毫秒的延迟。要计算新数据时钟，发送：   0x3D，并记录下的DXRA，DXRB，DZRA，DZRB，DYRA，DYRB设在寄存器3到8上的时钟脉冲。HMC5883L，将自动重新点回寄存器3进行下一个0x3D的查询。全部六个寄存器在新的数据写入任何一个寄存器前必须正确读取。


* 自测试操作

为确定HMC5883L是否能正常运行，其配备了自测功能模块以激励传感器偏移带产生一个待测的标称磁场强度(偏差磁场)。为执行该自测，配置寄存器A的最低位(MS1和MS0)从00更改为01。然后，通过在模式寄存器中设置进入单一测量模式(0x01)，在每个磁矢量其实有两次测量数据。第一次为置位脉冲后的外部磁场的测量数据。第二次是由X、Y、Z三轴设置为正偏置模式，传感器内部偏置带产生的正偏置电流(大约∼10mA)，而创建一个1.1高斯的自测磁场， 再加上外部磁场的测量数据。第二次测量值减去第一次测量值即可得出一个纯净的地磁测量值，而可以存放于数据输出寄存器中。

如果配置寄存器B保持在0x40工厂默认值，数值+951左右的 ADC LSB(1.16Ga * 820 LSB/Ga)将被放置在X和Y数据输出寄存器中，值+886左右(1.08Ga*820 LSB/Ga)会放在Z数据输出寄存器中。要离开自测试模式，将配置寄存器A MS1和MS0位设置回00。如果单一测量模式不是预设的操作模式，也要改变模式寄存器。


* 比例因数校准

使用上节SELF TEST OPERATION(自测操作)所述的方法，用户可校准传感器的灵敏度的比例以使相互匹配。因为装置放置在正偏置模式(或相对的负偏置模式) 对所有三轴都应用了已知的人造磁场，因而数据输出寄存器中的ADC测量结果可被用于传感器的比例校准。同样的，内置自测试程序可以用来定期地补偿由于温度变化而带来的比例误差。通过将自测试的数据输出与在已知的温度下得到的数据进行比较，可以找到一个补偿因数。例如，如果室温下自测试数据输出是1130，而在当前温度下数据输出是1150，那么（1130/1150）的比例因子应该应用于所有当前的磁场读数中。使用这种方式无须用到温度传感器。

>## 3.3 US-100超声波测距模块
>### 3.3.1 简介
US-100超声波测距模块可实现2cm~4.5m的非接触测距功能，拥有2.4~5.5V的宽电压输入范围，静态功耗低于2mA，自带温度传感器对测距结果进行校正，同时具有GPIO，串口等多种通信方式，内带看门狗，工作稳定可靠。
<div align=center>

US-100正面图

![](PIC/超声波实物图1.png)

US-100背面图

![](PIC/超声波实物图2.png)

</div>

>### 3.3.2 工作原理

* 电平触发测距工作原理
在模块上电前，首先去掉模式选择跳线上的跳线帽，使模块处于电平触发模式。

<div align=center>
测距时序图

![](PIC/超声波电平触发时序.png)

</div>
由图可知，只需在Trig/TX管脚输入一个10US以上的高电平，系统便可发出8个40KHz的超声波脉冲，然后检测回波信号。当检测到回波信号后，模块还要进行温度值测量，然后根据当前温度对测距结果进行校正，将校正的结果通过Echo/RX管脚输出。

在此模式下，模块将距离值转化为340m/s时的时间值得2倍，通过Echo端输出一高电平，可根据此高电平的持续时间来计算距离值。即距离值为：（高电平时间*340m/s）/2。

```
注：
因为距离值已经经过温度校正，此时无需再根据环境温度对超声波声速进行校正，即不管温度多少，声速选择340m/s即可。
```
* 串口触发测距工作原理

在模块上电前，首先插上模式选择跳线上的跳线帽，使模块处于串口触发模式。

<div align=center>
测距时序图

![](PIC/超声波串口触发时序.png)

</div>
在此模式下只需要Trig/TX管脚输入0X55（波特率9600），系统便可发出8个40KHz的超声波脉冲，然后检测回波信号。当检测到回波信号后，模块还要进行温度值的测量，然后根据当前温度对测距结果进行校正，将校正后的结果通过Echo/RX管脚输出。

输出距离值共两个字节时距离的高8位（HData），第二个字节为距离的低八位(LData)，单位为毫米。即距离值为（HData*256+LData）mm。

* 串口触发测温工作原理
在模块上电前，首先插上模式选择跳线上的跳线帽，使模块处于串口触发模式。
<div align=center>
测温时序图

![](PIC/串口触发测温时序图.png)

</div>
在此模式下只需要在Trig/Tx管脚输入0X50（波特率9600），系统便启动温度传感器对当前温度进行测量，然后将温度值通过Echo/RX管脚输出。

测量完成温度后，本模块会返回一个字节的温度值（TData），实际温度值为TData-45。例如通过TX发送完）0X50后，在RX端接收到0X45，则此时的温度值为[69(0X45的十进制)-45]=24度。

>### 3.3.3 基本应用电路

本模块共有两个接口，即模式选择跳线和5 Pin接口。模式选择跳线的间距为2.54mm，当插上跳线帽时为UART（串口）模式，拔掉时为电平触发模式。

* VCC Pin：接VCC电源（供电范围2.4V~5.5V）。

* Trig/TX Pin：当为UART模式时，接外部电路UART的TX端；当为电平触发模式时，接外部电路的Trig端。

* Echo/RX Pin：当为UART模式时，接外部电路UART的RX端；当为电平触发模式时，接外部电路的Echo端。

* GND Pin：接外部电路的地。

* GND Pin：接外部电路的地。

>### 3.3.4 基本配置方法

* 串口触发模式

只需要配置MCU的相关串口寄存器即可以完成数据

* 电平触发模式



>### 3.3.5 寄存器介绍


>## 3.4 气压计
>### 3.4.1 简介
>### 3.4.2 工作原理
>### 3.4.3 基本应用电路
>### 3.4.4 基本配置方法
>### 3.4.5 寄存器介绍



>## 3.5 GPS定位
>### 3.5.1 简介
>### 3.5.2 工作原理
>### 3.5.3 基本应用电路
>### 3.5.4 基本配置方法
>### 3.5.5 寄存器介绍


># 第三章 信号处理
